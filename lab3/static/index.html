<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lab 3: Raster Algorithms</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f0f0; }
        .container { display: flex; gap: 20px; margin-top: 20px; }
        .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 300px; }
        canvas { background: white; border: 1px solid #ccc; cursor: crosshair; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .row { margin-bottom: 10px; }
        label { display: inline-block; width: 30px; }
        input[type="number"] { width: 60px; }
        button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #0056b3; }
        .stats { margin-top: 20px; padding: 10px; background: #eef; border-radius: 4px; font-size: 0.9em; }
        h2 { margin: 0 0 10px 0; font-size: 1.2em; }
        .hidden { display: none; }
    </style>
</head>
<body>

<h1>Лаб 3: Базовые растровые алгоритмы</h1>

<div class="container">
    <div class="controls">
        <h2>Настройки</h2>
        
        <div class="row">
           <select id="algoSelect" style="width: 100%; padding: 5px;">
            <option value="step">Пошаговый алгоритм</option>
            <option value="dda">Алгоритм ЦДА (DDA)</option>
            <option value="bresenham_line">Брезенхем (Линия)</option>
            <option value="bresenham_circle">Брезенхем (Окружность)</option>
            <option value="casteljau">Де Кастельжо (Кривая Безье)</option>
            <option value="wu">Алгоритм Ву (Сглаживание)</option> <!-- Добавлено -->
            </select>
        </div>

        <div id="lineInputs">
            <h3>Координаты отрезка</h3>
            <div class="row">
                <label>X1:</label> <input type="number" id="x1" value="-5">
                <label>Y1:</label> <input type="number" id="y1" value="-5">
            </div>
            <div class="row">
                <label>X2:</label> <input type="number" id="x2" value="10">
                <label>Y2:</label> <input type="number" id="y2" value="8">
            </div>
        </div>

        <div id="circleInputs" class="hidden">
            <h3>Координаты окружности</h3>
            <div class="row">
                <label>X:</label> <input type="number" id="cx" value="0">
                <label>Y:</label> <input type="number" id="cy" value="0">
            </div>
            <div class="row">
                <label>R:</label> <input type="number" id="r" value="10" min="1">
            </div>
        </div>

        <div id="bezierInputs" class="hidden">
            <h3>Доп. точки Безье</h3>
            <div class="row">
                <label>X3:</label> <input type="number" id="x3" value="5">
                <label>Y3:</label> <input type="number" id="y3" value="-10">
            </div>
            <div class="row">
                <label>X4:</label> <input type="number" id="x4" value="10">
                <label>Y4:</label> <input type="number" id="y4" value="0">
            </div>
        </div>

        <div class="row" style="margin-top: 20px;">
            <label style="width: 100px;">Масштаб:</label>
            <input type="range" id="scaleRange" min="5" max="50" value="20">
        </div>

        <button onclick="draw()">Построить</button>
        <button onclick="clearCanvas()" style="background: #dc3545; margin-top: 5px;">Очистить</button>

        <div class="stats" id="statsOutput">
            Время выполнения: -
        </div>
        
        <p style="font-size: 0.8em; color: #666;">
            * Центр координат (0,0) находится в центре холста.
        </p>
    </div>

    <canvas id="canvas" width="600" height="600"></canvas>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Получаем ссылки на все группы инпутов
    const algoSelect = document.getElementById('algoSelect');
    const lineInputs = document.getElementById('lineInputs');
    const circleInputs = document.getElementById('circleInputs');
    const bezierInputs = document.getElementById('bezierInputs');
    
    // Параметры сетки
    let scale = 20; 
    let centerX = canvas.width / 2;
    let centerY = canvas.height / 2;

    // --- ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ИНТЕРФЕЙСА ---
    algoSelect.addEventListener('change', () => {
        const val = algoSelect.value;
        
        // Сначала скрываем всё
        lineInputs.classList.add('hidden');
        circleInputs.classList.add('hidden');
        bezierInputs.classList.add('hidden');

        if (val === 'bresenham_circle') {
            circleInputs.classList.remove('hidden');
        } 
        else if (val === 'casteljau') {
            lineInputs.classList.remove('hidden');
            bezierInputs.classList.remove('hidden');
            document.querySelector('#lineInputs h3').textContent = "Точки P1 (Старт) и P2 (Контроль 1)";
        } 
        else {
            // Для обычных линий и Ву
            lineInputs.classList.remove('hidden');
            document.querySelector('#lineInputs h3').textContent = "Координаты отрезка";
        }
    });

    document.getElementById('scaleRange').addEventListener('input', (e) => {
        scale = parseInt(e.target.value);
        drawGrid(); 
    });

    function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.beginPath();
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;

        for (let x = centerX; x < canvas.width; x += scale) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
        for (let x = centerX; x > 0; x -= scale) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
        
        for (let y = centerY; y < canvas.height; y += scale) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
        for (let y = centerY; y > 0; y -= scale) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY); 
        ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height); 
        ctx.stroke();

        ctx.fillStyle = 'black';
        ctx.font = '12px Arial';
        ctx.fillText("X", canvas.width - 15, centerY - 5);
        ctx.fillText("Y", centerX + 5, 15);
    }

    // --- ОБНОВЛЕННАЯ ФУНКЦИЯ РИСОВАНИЯ ПИКСЕЛЯ ---
    // Добавлен параметр alpha
    function drawPixel(logicalX, logicalY, color = '#007bff', alpha = 1.0) {
        const screenX = centerX + logicalX * scale;
        const screenY = centerY - logicalY * scale;

        ctx.fillStyle = color;
        
        // Сохраняем старую прозрачность
        const oldAlpha = ctx.globalAlpha;
        
        // Если пришла конкретная alpha (для Ву), используем её.
        // Для старых алгоритмов с сервера придет 0 (default float), поэтому ставим 1.0
        if (alpha > 0) {
            ctx.globalAlpha = alpha;
        } else {
            ctx.globalAlpha = 1.0;
        }

        ctx.fillRect(screenX + 1, screenY - scale + 1, scale - 2, scale - 2);

        // Восстанавливаем прозрачность, чтобы сетка не испортилась
        ctx.globalAlpha = oldAlpha;
    }

    // --- ФУНКЦИЯ ОТПРАВКИ ЗАПРОСА ---
    async function draw() {
        drawGrid();
        
        const algo = algoSelect.value;
        const req = { algorithm: algo };

        if (algo === 'bresenham_circle') {
            req.x1 = parseInt(document.getElementById('cx').value);
            req.y1 = parseInt(document.getElementById('cy').value);
            req.r = parseInt(document.getElementById('r').value);
        } 
        else if (algo === 'casteljau') {
            req.x1 = parseInt(document.getElementById('x1').value);
            req.y1 = parseInt(document.getElementById('y1').value);
            req.x2 = parseInt(document.getElementById('x2').value);
            req.y2 = parseInt(document.getElementById('y2').value);
            req.x3 = parseInt(document.getElementById('x3').value);
            req.y3 = parseInt(document.getElementById('y3').value);
            req.x4 = parseInt(document.getElementById('x4').value);
            req.y4 = parseInt(document.getElementById('y4').value);
        } 
        else {
            // Обычные линии + Ву
            req.x1 = parseInt(document.getElementById('x1').value);
            req.y1 = parseInt(document.getElementById('y1').value);
            req.x2 = parseInt(document.getElementById('x2').value);
            req.y2 = parseInt(document.getElementById('y2').value);
        }

        try {
            const res = await fetch('/api/draw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(req)
            });
            const data = await res.json();

            if (data.points) {
                // Выбираем цвет
                let color = '#007bff'; // Синий по умолчанию
                if (algo === 'casteljau') color = '#dc3545'; // Красный для Безье
                if (algo === 'wu') color = '#000000'; // Черный для Ву (так лучше видно сглаживание)
                
                // Рисуем каждый пиксель, передавая прозрачность (p.alpha)
                data.points.forEach(p => drawPixel(p.x, p.y, color, p.alpha));

                // Опорные точки для Безье
                if (algo === 'casteljau') {
                     drawPixel(req.x1, req.y1, 'orange'); 
                     drawPixel(req.x2, req.y2, '#ccc');   
                     drawPixel(req.x3, req.y3, '#ccc');   
                     drawPixel(req.x4, req.y4, 'orange'); 
                }
            }
            
            document.getElementById('statsOutput').textContent = 
                `Время выполнения (Go): ${data.time_ns} нс`;

        } catch (e) {
            alert('Ошибка: ' + e);
        }
    }

    function clearCanvas() {
        drawGrid();
        document.getElementById('statsOutput').textContent = "Время выполнения: -";
    }

    // Инициализация
    drawGrid();
    
</script>
</body>
</html>