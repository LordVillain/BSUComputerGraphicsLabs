<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lab 2: Processing & Compression</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        h1 { color: #333; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .image-container { min-height: 300px; display: flex; align-items: center; justify-content: center; background: #eee; border: 1px dashed #ccc; margin-top: 10px; }
        img { max-width: 100%; max-height: 400px; display: block; }
        .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 10px; font-weight: bold; }
        select, input[type="file"], button { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { background: #28a745; color: white; border: none; cursor: pointer; font-size: 16px; }
        button:hover { background: #218838; }
        .hidden { display: none; }
        #infoBox { white-space: pre-wrap; background: #e9ecef; padding: 10px; border-radius: 4px; border-left: 5px solid #007bff; margin-top: 10px;}
    </style>
</head>
<body>

<h1>Лабораторная работа 2: Обработка и Сжатие</h1>

<div class="controls">
    <label>1. Загрузите изображение:</label>
    <input type="file" id="fileInput" accept="image/*">

    <label>2. Выберите алгоритм:</label>
    <select id="methodSelect">
        <optgroup label="Вариант (Обработка)">
            <option value="contrast">Линейное контрастирование (Element-wise)</option>
            <option value="threshold_otsu">Глобальный порог (Оцу)</option>
            <option value="threshold_manual">Глобальный порог (Ручной)</option>
        </optgroup>
        <optgroup label="Сжатие (Из лекции)">
            <option value="compression_rle">Алгоритм RLE (Run-Length Encoding)</option>
        </optgroup>
    </select>

    <div id="manualControls" class="hidden">
        <label>Значение порога (0-255): <span id="threshValDisplay">128</span></label>
        <input type="range" id="thresholdRange" min="0" max="255" value="128">
    </div>

    <button onclick="processImage()">Выполнить</button>
</div>

<div class="grid">
    <div class="card">
        <h3>Исходное изображение</h3>
        <div class="image-container">
            <img id="sourceImage" alt="Preview">
        </div>
    </div>
    <div class="card">
        <h3>Результат / Информация</h3>
        <div id="infoBox" class="hidden"></div>
        <div class="image-container">
            <img id="resultImage" alt="Result">
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const methodSelect = document.getElementById('methodSelect');
    const manualControls = document.getElementById('manualControls');
    const thresholdRange = document.getElementById('thresholdRange');
    const threshValDisplay = document.getElementById('threshValDisplay');
    const sourceImage = document.getElementById('sourceImage');
    const resultImage = document.getElementById('resultImage');
    const infoBox = document.getElementById('infoBox');

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) sourceImage.src = URL.createObjectURL(file);
    });

    methodSelect.addEventListener('change', () => {
        if (methodSelect.value === 'threshold_manual') {
            manualControls.classList.remove('hidden');
        } else {
            manualControls.classList.add('hidden');
        }
    });

    thresholdRange.addEventListener('input', () => {
        threshValDisplay.textContent = thresholdRange.value;
    });

    async function processImage() {
        if (!fileInput.files[0]) { alert("Выберите файл!"); return; }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('method', methodSelect.value);
        formData.append('threshold_value', thresholdRange.value);

        try {
            resultImage.style.opacity = 0.5;
            const res = await fetch('/api/process', { method: 'POST', body: formData });
            if (!res.ok) throw new Error(await res.text());

            const data = await res.json();
            
            // Отображаем картинку
            resultImage.src = data.image;
            
            // Отображаем информацию (текст или статистику сжатия)
            if (data.info) {
                infoBox.textContent = data.info;
                infoBox.classList.remove('hidden');
            } else {
                infoBox.classList.add('hidden');
            }

        } catch (e) {
            alert("Ошибка: " + e.message);
        } finally {
            resultImage.style.opacity = 1;
        }
    }
</script>

</body>
</html>